# --- Security headers (SPA-safe) ---
add_header X-Frame-Options DENY always;
add_header X-Content-Type-Options nosniff always;
add_header Referrer-Policy no-referrer-when-downgrade always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# --- Compression ---
gzip on;
gzip_types text/plain text/css application/javascript application/json image/svg+xml font/woff2 application/font-woff;
gzip_min_length 1024;

# --- Static assets: cache hard ---
location ~* \.(?:js|mjs|css|png|jpg|jpeg|gif|svg|ico|webp|woff2?)$ {
  expires 30d;
  add_header Cache-Control "public, immutable";
  try_files $uri =404;
}

# --- HTML: no cache ---
location = /index.html {
  add_header Cache-Control "no-cache";
}

# --- API proxy (SSE/WebSocket-friendly) ---
location /api/ {
  proxy_pass         http://127.0.0.1:5000/api/;  # replace port per env
  proxy_http_version 1.1;

  proxy_set_header   Host $host;
  proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header   X-Forwarded-Proto $scheme;

  proxy_set_header   Upgrade $http_upgrade;
  proxy_set_header   Connection "upgrade";

  proxy_buffering off;
  proxy_read_timeout  1h;
  proxy_send_timeout  1h;
  proxy_connect_timeout 5s;
  proxy_redirect off;
}

# --- SPA fallback ---
location / {
  try_files $uri /index.html;
}

